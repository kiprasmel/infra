#!/usr/bin/env bash
set -euo pipefail

INFRA_DIR="$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")"
REMOTE_INFRA_DIR="\$HOME/infra"

resolve_project_dir() {
    local project="$1"
    local project_dir="server/$project"
    test -d "$INFRA_DIR/$project_dir" || {
        >&2 echo "error: project '$project' not found in server/"
        exit 1
    }
    echo "$project_dir"
}

# ssh into remote and cd to project directory
cmd_cd() {
    local remote="$1"; shift
    local project="$1"; shift
    local project_dir; project_dir="$(resolve_project_dir "$project")"
    
    ssh -t -o LogLevel=ERROR "$remote" "cd $REMOTE_INFRA_DIR/$project_dir && exec \$SHELL -l"
}

# run a script in the project directory on remote
cmd_exec() {
    local remote="$1"; shift
    local project="$1"; shift
    local script="$1"; shift
    local project_dir; project_dir="$(resolve_project_dir "$project")"
    
    ssh -t -o LogLevel=ERROR "$remote" "\$SHELL -l -c 'cd $REMOTE_INFRA_DIR/$project_dir && ./$script $*'"
}

case "${1:-}" in
    cd)   shift; cmd_cd "$@" ;;
    exec) shift; cmd_exec "$@" ;;
    *)    echo "usage: infra <cd|exec> <remote> <project> [script] [args...]"; exit 1 ;;
esac
